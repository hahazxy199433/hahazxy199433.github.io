<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>React 源码解读（二） Fiber Root | zxy的前端日志</title>
    <meta name="description" content="大前端之路开启">
    <link rel="icon" href="/blog/react.png">
    
    <link rel="preload" href="/blog/assets/css/0.styles.9d1099df.css" as="style"><link rel="preload" href="/blog/assets/js/app.14c06185.js" as="script"><link rel="preload" href="/blog/assets/js/2.16662708.js" as="script"><link rel="preload" href="/blog/assets/js/48.ec4dcb12.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.00cea59a.js"><link rel="prefetch" href="/blog/assets/js/11.05842238.js"><link rel="prefetch" href="/blog/assets/js/12.2132831f.js"><link rel="prefetch" href="/blog/assets/js/13.bf3e9701.js"><link rel="prefetch" href="/blog/assets/js/14.192538db.js"><link rel="prefetch" href="/blog/assets/js/15.033e1123.js"><link rel="prefetch" href="/blog/assets/js/16.c0015fd7.js"><link rel="prefetch" href="/blog/assets/js/17.a17b1e9b.js"><link rel="prefetch" href="/blog/assets/js/18.b93849d7.js"><link rel="prefetch" href="/blog/assets/js/19.49c83340.js"><link rel="prefetch" href="/blog/assets/js/20.68455ea4.js"><link rel="prefetch" href="/blog/assets/js/21.377e94d2.js"><link rel="prefetch" href="/blog/assets/js/22.9b4bb021.js"><link rel="prefetch" href="/blog/assets/js/23.3bd837ed.js"><link rel="prefetch" href="/blog/assets/js/24.aa8ee29d.js"><link rel="prefetch" href="/blog/assets/js/25.fcb61494.js"><link rel="prefetch" href="/blog/assets/js/26.12eb4d55.js"><link rel="prefetch" href="/blog/assets/js/27.f6e054a2.js"><link rel="prefetch" href="/blog/assets/js/28.61b25aed.js"><link rel="prefetch" href="/blog/assets/js/29.a55ad6bc.js"><link rel="prefetch" href="/blog/assets/js/3.d94a3e9c.js"><link rel="prefetch" href="/blog/assets/js/30.889fcc7b.js"><link rel="prefetch" href="/blog/assets/js/31.e93dc090.js"><link rel="prefetch" href="/blog/assets/js/32.f8b711de.js"><link rel="prefetch" href="/blog/assets/js/33.21b64a3e.js"><link rel="prefetch" href="/blog/assets/js/34.4d542d57.js"><link rel="prefetch" href="/blog/assets/js/35.286cb44d.js"><link rel="prefetch" href="/blog/assets/js/36.7881579e.js"><link rel="prefetch" href="/blog/assets/js/37.3957416f.js"><link rel="prefetch" href="/blog/assets/js/38.45df55c6.js"><link rel="prefetch" href="/blog/assets/js/39.9fd79313.js"><link rel="prefetch" href="/blog/assets/js/4.4f80862e.js"><link rel="prefetch" href="/blog/assets/js/40.e4075746.js"><link rel="prefetch" href="/blog/assets/js/41.ef3d56b0.js"><link rel="prefetch" href="/blog/assets/js/42.ab9b071c.js"><link rel="prefetch" href="/blog/assets/js/43.af6bfe20.js"><link rel="prefetch" href="/blog/assets/js/44.80ee27fe.js"><link rel="prefetch" href="/blog/assets/js/45.4fefa068.js"><link rel="prefetch" href="/blog/assets/js/46.71d8c89a.js"><link rel="prefetch" href="/blog/assets/js/47.804a939f.js"><link rel="prefetch" href="/blog/assets/js/49.71cdc340.js"><link rel="prefetch" href="/blog/assets/js/5.dfc00d35.js"><link rel="prefetch" href="/blog/assets/js/50.3d50adfb.js"><link rel="prefetch" href="/blog/assets/js/51.73d10799.js"><link rel="prefetch" href="/blog/assets/js/52.ba03adcf.js"><link rel="prefetch" href="/blog/assets/js/53.fd8668ba.js"><link rel="prefetch" href="/blog/assets/js/54.8a0e48bf.js"><link rel="prefetch" href="/blog/assets/js/55.dfc93b1b.js"><link rel="prefetch" href="/blog/assets/js/56.257b62f5.js"><link rel="prefetch" href="/blog/assets/js/57.9351d7d9.js"><link rel="prefetch" href="/blog/assets/js/58.2347da61.js"><link rel="prefetch" href="/blog/assets/js/59.24dc8a01.js"><link rel="prefetch" href="/blog/assets/js/6.a1fa0e20.js"><link rel="prefetch" href="/blog/assets/js/60.6e9ff53d.js"><link rel="prefetch" href="/blog/assets/js/61.96d82c7f.js"><link rel="prefetch" href="/blog/assets/js/62.98490a70.js"><link rel="prefetch" href="/blog/assets/js/63.5479fb28.js"><link rel="prefetch" href="/blog/assets/js/64.f7ce55cf.js"><link rel="prefetch" href="/blog/assets/js/65.c5beb8a5.js"><link rel="prefetch" href="/blog/assets/js/66.fe04c917.js"><link rel="prefetch" href="/blog/assets/js/67.f4396ba2.js"><link rel="prefetch" href="/blog/assets/js/68.c11393d4.js"><link rel="prefetch" href="/blog/assets/js/69.f58f3157.js"><link rel="prefetch" href="/blog/assets/js/7.beece5c8.js"><link rel="prefetch" href="/blog/assets/js/70.be44a000.js"><link rel="prefetch" href="/blog/assets/js/71.2fc28cae.js"><link rel="prefetch" href="/blog/assets/js/72.a68e888e.js"><link rel="prefetch" href="/blog/assets/js/73.63a89c6c.js"><link rel="prefetch" href="/blog/assets/js/8.a04eebc1.js"><link rel="prefetch" href="/blog/assets/js/9.85553b55.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.9d1099df.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">zxy的前端日志</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/blog/" class="nav-link router-link-active">博客</a></div><div class="nav-item"><a href="/blog/interview/" class="nav-link">面试题</a></div><div class="nav-item"><a href="/blog/book/" class="nav-link">阅读</a></div> <a href="https://github.com/zxy/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/blog/" class="nav-link router-link-active">博客</a></div><div class="nav-item"><a href="/blog/interview/" class="nav-link">面试题</a></div><div class="nav-item"><a href="/blog/book/" class="nav-link">阅读</a></div> <a href="https://github.com/zxy/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Framework(大佬写的)</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/blog/library-node.html" class="sidebar-link">Node.js 使用总结</a></li><li><a href="/blog/blog/library-react.html" class="sidebar-link">React 使用总结</a></li><li><a href="/blog/blog/libary-react-core.html" class="sidebar-link">React 核心知识</a></li><li><a href="/blog/blog/library-react-code-1.html" class="sidebar-link">React 源码解析（一）JSX 转换</a></li><li><a href="/blog/blog/library-react-code-2.html" class="sidebar-link">React 源码解析（二）FiberRoot 构建</a></li><li><a href="/blog/blog/library-react-code-3.html" class="sidebar-link">React 源码解析（三）Fiber 的调度过程</a></li><li><a href="/blog/blog/library-react-ssr.html" class="sidebar-link">React 服务器端渲染</a></li><li><a href="/blog/blog/library-react-hooks.html" class="sidebar-link">使用 React Hooks 节省 90% 的代码</a></li><li><a href="/blog/blog/library-vue.html" class="sidebar-link">Vue 使用总结</a></li><li><a href="/blog/blog/library-miniProgram.html" class="sidebar-link">小程序使用总结</a></li><li><a href="/blog/blog/library-redux.html" class="sidebar-link">Redux 使用总结</a></li><li><a href="/blog/blog/library-rxjs.html" class="sidebar-link">RxJS 基础知识总结</a></li><li><a href="/blog/blog/libary-koa.html" class="sidebar-link">Koa 源代码阅读</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>PHP</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/blog/2019-05-28-php.html" class="sidebar-link">PHP学习(一) 基础语法</a></li><li><a href="/blog/blog/2019-06-05-php&amp;mysql.html" class="sidebar-link">PHP学习(二) php与mysql</a></li><li><a href="/blog/blog/2019-06-05-php_OOP_introduction.html" class="sidebar-link">PHP学习(三) php面向对象介绍</a></li><li><a href="/blog/blog/2019-06-05-PHP_construct.html" class="sidebar-link">PHP学习(四) 构造方法和析构方法</a></li><li><a href="/blog/blog/2019-06-10-OOP_fengzhuang.html" class="sidebar-link">PHP学习(五) PHP面向对象之封装性</a></li><li><a href="/blog/blog/2019-06-10-OOP_jicheng_duotai.html" class="sidebar-link">PHP学习(六) PHP面向对象之继承与多态</a></li><li><a href="/blog/blog/2019-06-10-OOP_interface_abstract.html" class="sidebar-link">PHP学习(七) PHP抽象类与接口</a></li><li><a href="/blog/blog/2019-06-11-OPP_error.html" class="sidebar-link">PHP学习(八) PHP异常处理</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>node</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/blog/2019-06-25-node.html" class="sidebar-link">Node.js学习(基础)</a></li><li><a href="/blog/blog/2019-06-26-express1.html" class="sidebar-link">express学习(一) express介绍</a></li><li><a href="/blog/blog/2019-06-27-express-middleware.html" class="sidebar-link">express学习(二) 中间件</a></li><li><a href="/blog/blog/2019-06-27-express-router.html" class="sidebar-link">express学习(三) 路由</a></li><li><a href="/blog/blog/2019-06-27-express-error.html" class="sidebar-link">express学习(四) 错误处理</a></li><li><a href="/blog/blog/2019-08-19-node.html" class="sidebar-link">大规模NodeJS项目架构与优化</a></li><li><a href="/blog/blog/2019-08-20-express.html" class="sidebar-link">express入门实战</a></li><li><a href="/blog/blog/2019-08-20-node-pachong.html" class="sidebar-link">爬虫</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>工程化</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/blog/2019-06-27-qa.html" class="sidebar-link">Javascript与QA工程师(一)</a></li><li><a href="/blog/blog/2019-08-04-QA.html" class="sidebar-link">Javascript与QA工程师(二)</a></li><li><a href="/blog/blog/2019-07-05-webpack1.html" class="sidebar-link">webpack4学习(一) webpack的核心概念</a></li><li><a href="/blog/blog/2019-07-05-webpack2.html" class="sidebar-link">webpack4学习(二) webpack的高级概念</a></li><li><a href="/blog/blog/2019-07-09-webpack3.html" class="sidebar-link">webpack4学习(三) webpack实战配置</a></li><li><a href="/blog/blog/2019-07-10-webpack4.html" class="sidebar-link">webpack4学习(四) webpack底层原理及脚手架工具分析</a></li><li><a href="/blog/blog/webpack-0-1.html" class="sidebar-link">webpack4 从0到1搭建</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>js基础</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/blog/" class="sidebar-link">博客</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>编程基础</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/blog/2019-07-31-fp-.html" class="sidebar-link">函数式编程</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Linux</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/blog/2019-05-27-Linux-instructions.html" class="sidebar-link">Linux常用指令</a></li><li><a href="/blog/blog/2019-07-31-linux.html" class="sidebar-link">Linux预读</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>网络协议</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/blog/2019-08-14-http1.html" class="sidebar-link">HTTP协议那些事(一)</a></li><li><a href="/blog/blog/2019-08-15-http2.html" class="sidebar-link">HTTP协议那些事(二)</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>源码解读</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/blog/react源码1.html" class="sidebar-link">React 源码解读（一）</a></li><li><a href="/blog/blog/react源码2.html" class="active sidebar-link">React 源码解读（二） Fiber Root</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/blog/react源码2.html#创建-fiberroot" class="sidebar-link">创建 FiberRoot</a></li><li class="sidebar-sub-header"><a href="/blog/blog/react源码2.html#expirationtime" class="sidebar-link">expirationTime</a></li><li class="sidebar-sub-header"><a href="/blog/blog/react源码2.html#schedulework" class="sidebar-link">scheduleWork</a></li><li class="sidebar-sub-header"><a href="/blog/blog/react源码2.html#总结" class="sidebar-link">总结</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="react-源码解读（二）-fiber-root"><a href="#react-源码解读（二）-fiber-root" class="header-anchor">#</a> React 源码解读（二） Fiber Root</h1> <p>在react 16之前，组件渲染是不能被打断的，这就导致当项目非常大的时候，只能等待渲染完才能做其他事。
而在 16 之后，React.render 新增了 fiber 机制。
可以在更新过程中中断任务来执行优先级更高的任务。</p> <p>fiber 分为两个阶段</p> <ul><li><strong>reconciliation</strong> 阶段
fiberNode为单位，调度的时候，每更新一个fiber，返回去询问，是否有优先级更高的任务，接下来的任务会中断，不会实际渲染到页面，update，打上 effectTag</li> <li><strong>commit</strong> 阶段
处理这些标记，渲染到页面，这个过程是不能被打断的</li></ul> <p>它的流程具体是怎么样的?
优先级更高的任务，如何判断优先级?</p> <h2 id="创建-fiberroot"><a href="#创建-fiberroot" class="header-anchor">#</a> 创建 FiberRoot</h2> <p>顺着流程走，代码会在 ReactDOM.render 中执行
在源码中可以看到依次执行了以下几个方法</p> <ul><li>legacyRenderSubtreeIntoContainer</li> <li>legacyCreateRootFromDOMContainer</li> <li>ReactRoot</li> <li>进入 react-reconciler 库
<ul><li>具体通过 createContainer -&gt; createFiberRoot 创建 fiberRoot。</li></ul></li></ul> <p><strong>legacyRenderSubtreeIntoContainer</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">legacyRenderSubtreeIntoContainer</span><span class="token punctuation">(</span>
  parentComponent<span class="token punctuation">:</span> <span class="token operator">?</span>React$Component<span class="token operator">&lt;</span>any<span class="token punctuation">,</span> any<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  children<span class="token punctuation">:</span> ReactNodeList<span class="token punctuation">,</span>
  container<span class="token punctuation">:</span> DOMContainer<span class="token punctuation">,</span>
  forceHydrate<span class="token punctuation">:</span> boolean<span class="token punctuation">,</span>  <span class="token comment">// forceHydrate 的作用是是否需要复用节点，在服务端渲染中它会被设为true</span>
  callback<span class="token punctuation">:</span> <span class="token operator">?</span>Function<span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token keyword">let</span> root<span class="token punctuation">:</span> Root <span class="token operator">=</span> <span class="token punctuation">(</span>container<span class="token punctuation">.</span>_reactRootContainer<span class="token punctuation">:</span> any<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 第一次root 不存在</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>root<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Initial mount  </span>
    <span class="token comment">// 创建reactRoot，在dom元素上挂载, </span>
    root <span class="token operator">=</span> container<span class="token punctuation">.</span>_reactRootContainer <span class="token operator">=</span> <span class="token function">legacyCreateRootFromDOMContainer</span><span class="token punctuation">(</span>
      container<span class="token punctuation">,</span>
      forceHydrate<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// Initial mount should not be batched.</span>
    <span class="token comment">// 首次不用批量更新， batchedUpdate是等view更新完之后在去统一更新状态，</span>
    <span class="token comment">// 有一个等待的过程， 第一次不需要，可以更快</span>
    <span class="token function">unbatchedUpdates</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>parentComponent <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        root<span class="token punctuation">.</span><span class="token function">legacy_renderSubtreeIntoContainer</span><span class="token punctuation">(</span>
          parentComponent<span class="token punctuation">,</span>
          children<span class="token punctuation">,</span>
          callback<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// ReactRoot.prototype.render</span>
        root<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>children<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 省略代码</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>在 legacyRenderSubtreeIntoContainer 方法中，第一次root 不存在时，创建了reactRoot 在dom元素上挂载
forceHydrate 参数被传入到了 legacyCreateRootFromDOMContainer中</p> <p><strong>legacyCreateRootFromDOMContainer</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">legacyCreateRootFromDOMContainer</span><span class="token punctuation">(</span>
  <span class="token parameter">container<span class="token punctuation">:</span> DOMContainer<span class="token punctuation">,</span>
  forceHydrate<span class="token punctuation">:</span> boolean<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token punctuation">:</span> Root <span class="token punctuation">{</span>
  <span class="token comment">// 是否需要复用节点</span>
  <span class="token keyword">const</span> shouldHydrate <span class="token operator">=</span>
    forceHydrate <span class="token operator">||</span> <span class="token function">shouldHydrateDueToLegacyHeuristic</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// First clear any existing content.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>shouldHydrate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> warned <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> rootSibling<span class="token punctuation">;</span>
    <span class="token comment">// 删除子节点</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>rootSibling <span class="token operator">=</span> container<span class="token punctuation">.</span>lastChild<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      container<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>rootSibling<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// Legacy roots are not async by default.</span>
  <span class="token keyword">const</span> isConcurrent <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token comment">// 返回一个新创建的ReactRoot</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ReactRoot</span><span class="token punctuation">(</span>container<span class="token punctuation">,</span> isConcurrent<span class="token punctuation">,</span> shouldHydrate<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>ReactRoot 通过 createContainer 创建了 FiberRoot
<strong>ReactRoot</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">ReactRoot</span><span class="token punctuation">(</span>
  <span class="token parameter">container<span class="token punctuation">:</span> DOMContainer<span class="token punctuation">,</span>
  isConcurrent<span class="token punctuation">:</span> boolean<span class="token punctuation">,</span>
  hydrate<span class="token punctuation">:</span> boolean<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 创建FiberRoot</span>
  <span class="token keyword">const</span> root <span class="token operator">=</span> <span class="token function">createContainer</span><span class="token punctuation">(</span>container<span class="token punctuation">,</span> isConcurrent<span class="token punctuation">,</span> hydrate<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 把创建的节点绑在_internalRoot属性上</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_internalRoot <span class="token operator">=</span> root<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>创建fiber tree 的过程</p> <p><img src="library-react-tree-demo-Fiber.png" alt="cmd-react-children"></p> <p>这里我们再来捋一下</p> <p>ReactDOM.render 通过 legacyCreateRootFromDOMContainer 创建了 ReactRoot</p> <p>ReactRoot 又创建了 FiberRoot</p> <p>FiberRoot 又有如下几个比较重要的属性</p> <ul><li>current</li> <li>containerInfo</li> <li>finishedWork 在reconciliation 阶段，把一个update 推到 finishedWork，在 commit 阶段处理它</li> <li>expirationTime</li></ul> <h2 id="expirationtime"><a href="#expirationtime" class="header-anchor">#</a> expirationTime</h2> <p>ReactRoot.prototype.render =&gt; updateContainer() =&gt; ExpirationTime
render 的过程中调用了 updateContainer，和前面 createContainer 相对应，进行更新操作，而 updateContainer 返回的是个 ExpirationTime</p> <p><strong>updateContainer</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// updateContainer为啥返回一个ExpirationTime？</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">updateContainer</span><span class="token punctuation">(</span>
  <span class="token parameter">element<span class="token punctuation">:</span> ReactNodeList<span class="token punctuation">,</span>
  container<span class="token punctuation">:</span> OpaqueRoot<span class="token punctuation">,</span>
  parentComponent<span class="token punctuation">:</span> <span class="token operator">?</span>React$Component<span class="token operator">&lt;</span>any<span class="token punctuation">,</span> any<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  callback<span class="token punctuation">:</span> <span class="token operator">?</span>Function<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token punctuation">:</span> ExpirationTime <span class="token punctuation">{</span>
  
  <span class="token keyword">const</span> current <span class="token operator">=</span> container<span class="token punctuation">.</span>current<span class="token punctuation">;</span>
  <span class="token comment">// 通过 msToExpirationTime 得到currentTime</span>
  <span class="token keyword">const</span> currentTime <span class="token operator">=</span> <span class="token function">requestCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 根据给任务分优先级，来得到不同的过期时间</span>
  <span class="token keyword">const</span> expirationTime <span class="token operator">=</span> <span class="token function">computeExpirationForFiber</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">,</span> current<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">updateContainerAtExpirationTime</span><span class="token punctuation">(</span>
    element<span class="token punctuation">,</span>
    container<span class="token punctuation">,</span>
    parentComponent<span class="token punctuation">,</span>
    expirationTime<span class="token punctuation">,</span>
    callback<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>在返回之前先获取了 expirationTime
那就先看看 expirationTime 是什么
computeExpirationForFiber =&gt; 计算不同的过期时间
找到 computeExpirationForFiber 方法</p> <p>这里有一个设置优先级的操作，也就是 getCurrentPriorityLevel，这里最后又调到了 Scheduler.js 的东西，也是 Scheduler 中最重要的部分</p> <p>通过设置了5个等级的优先级，分别对应着超时时间，优先级越高，ExpirationTime 超时时间越低</p> <p><strong>Scheduler.js</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// TODO: Use symbols?</span>
<span class="token keyword">var</span> ImmediatePriority <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> UserBlockingPriority <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> NormalPriority <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> LowPriority <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> IdlePriority <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>

<span class="token comment">// Max 31 bit integer. The max integer size in V8 for 32-bit systems.</span>
<span class="token comment">// Math.pow(2, 30) - 1</span>
<span class="token comment">// 0b111111111111111111111111111111</span>
<span class="token keyword">var</span> maxSigned31BitInt <span class="token operator">=</span> <span class="token number">1073741823</span><span class="token punctuation">;</span>

<span class="token comment">// Times out immediately, 比0还小，立即执行</span>
<span class="token keyword">var</span> <span class="token constant">IMMEDIATE_PRIORITY_TIMEOUT</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token comment">// Eventually times out</span>
<span class="token keyword">var</span> <span class="token constant">USER_BLOCKING_PRIORITY</span> <span class="token operator">=</span> <span class="token number">250</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> <span class="token constant">NORMAL_PRIORITY_TIMEOUT</span> <span class="token operator">=</span> <span class="token number">5000</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> <span class="token constant">LOW_PRIORITY_TIMEOUT</span> <span class="token operator">=</span> <span class="token number">10000</span><span class="token punctuation">;</span>
<span class="token comment">// Never times out</span>
<span class="token keyword">var</span> <span class="token constant">IDLE_PRIORITY</span> <span class="token operator">=</span> maxSigned31BitInt<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>下面是 computeExpirationForFiber 方法，用来计算不同的过期时间</p> <p><strong>computeExpirationForFiber</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 计算不同的过期时间</span>
<span class="token keyword">function</span> <span class="token function">computeExpirationForFiber</span><span class="token punctuation">(</span><span class="token parameter">currentTime<span class="token punctuation">:</span> ExpirationTime<span class="token punctuation">,</span> fiber<span class="token punctuation">:</span> Fiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// var ImmediatePriority = 1; 最高优先级， 直接走messageChannel 直接处理</span>
  <span class="token comment">// var UserBlockingPriority = 2;</span>
  <span class="token comment">// var NormalPriority = 3;  默认</span>
  <span class="token comment">// var LowPriority = 4;</span>
  <span class="token comment">// var IdlePriority = 5;</span>
  <span class="token comment">// 优先级越高，ExpirationTime 超时时间越低</span>
  <span class="token keyword">const</span> priorityLevel <span class="token operator">=</span> <span class="token function">getCurrentPriorityLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> expirationTime<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>mode <span class="token operator">&amp;</span> ConcurrentMode<span class="token punctuation">)</span> <span class="token operator">===</span> NoContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Outside of concurrent mode, updates are always synchronous.</span>
    <span class="token comment">// 在并发模式之外，更新始终是同步的。</span>
    expirationTime <span class="token operator">=</span> Sync<span class="token punctuation">;</span>
    <span class="token comment">// isWorking 在renderRoot或者CommitRoot</span>
    <span class="token comment">// isCommitting CommitRoot</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>isWorking <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isCommitting<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// isWorking 在 commitRoot 和 renderRoot 时被设置为true</span>
    <span class="token comment">// isCommitting 在 commitRoot 时被设置为true</span>
    <span class="token comment">// 所以在render阶段，优先级 expirationTime 设置为下次渲染的到期时间</span>
    <span class="token comment">// During render phase, updates expire during as the current render.</span>
    expirationTime <span class="token operator">=</span> nextRenderExpirationTime<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 在commit阶段，根据priorityLevel进行expirationTime更新</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>priorityLevel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> ImmediatePriority<span class="token punctuation">:</span>
        <span class="token comment">// 立即执行</span>
        expirationTime <span class="token operator">=</span> Sync<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> UserBlockingPriority<span class="token punctuation">:</span>
        <span class="token comment">// 因用户交互阻塞的优先级</span>
        expirationTime <span class="token operator">=</span> <span class="token function">computeInteractiveExpiration</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> NormalPriority<span class="token punctuation">:</span>
        <span class="token comment">// 一般，默认优先级， 异步执行</span>
        <span class="token comment">// This is a normal, concurrent update</span>
        expirationTime <span class="token operator">=</span> <span class="token function">computeAsyncExpiration</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> LowPriority<span class="token punctuation">:</span>
      <span class="token keyword">case</span> IdlePriority<span class="token punctuation">:</span>
        <span class="token comment">// 低优先级或空闲状态</span>
        expirationTime <span class="token operator">=</span> Never<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">default</span><span class="token punctuation">:</span>
        <span class="token function">invariant</span><span class="token punctuation">(</span>
          <span class="token boolean">false</span><span class="token punctuation">,</span>
          <span class="token string">'Unknown priority level. This error is likely caused by a bug in '</span> <span class="token operator">+</span>
            <span class="token string">'React. Please file an issue.'</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// If we're in the middle of rendering a tree, do not update at the same</span>
    <span class="token comment">// expiration time that is already rendering.</span>
    <span class="token comment">// 下一个fiber存在，且当前的fiber的过期时间和下一个fiber的过期时间一致</span>
    <span class="token comment">// 把当前的fiber的过期时间减1 </span>
    <span class="token comment">// 避免在渲染树的时候同时去更新已经渲染的树</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nextRoot <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> expirationTime <span class="token operator">===</span> nextRenderExpirationTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      expirationTime <span class="token operator">-=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Keep track of the lowest pending interactive expiration time. This</span>
  <span class="token comment">// allows us to synchronously flush all interactive updates</span>
  <span class="token comment">// when needed.</span>
  <span class="token comment">// TODO: Move this to renderer?</span>
  <span class="token comment">// 记录下挂起的用户交互任务中expirationTime最短的一个，在需要时同步刷新所有交互式更新</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    priorityLevel <span class="token operator">===</span> UserBlockingPriority <span class="token operator">&amp;&amp;</span>
    <span class="token punctuation">(</span>lowestPriorityPendingInteractiveExpirationTime <span class="token operator">===</span> NoWork <span class="token operator">||</span>
      expirationTime <span class="token operator">&lt;</span> lowestPriorityPendingInteractiveExpirationTime<span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    lowestPriorityPendingInteractiveExpirationTime <span class="token operator">=</span> expirationTime<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> expirationTime<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br></div></div><p>下面再回到 updateContainer 方法（调来调去的有点乱）, 最后 return 了 updateContainerAtExpirationTime，updateContainerAtExpirationTime 又返回了 scheduleRootUpdate</p> <p>updateContainer() =&gt; updateContainerAtExpirationTime() =&gt; scheduleRootUpdate()</p> <p><strong>scheduleRootUpdate</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">scheduleRootUpdate</span><span class="token punctuation">(</span>
  <span class="token parameter">current<span class="token punctuation">:</span> Fiber<span class="token punctuation">,</span>
  element<span class="token punctuation">:</span> ReactNodeList<span class="token punctuation">,</span>
  expirationTime<span class="token punctuation">:</span> ExpirationTime<span class="token punctuation">,</span>
  callback<span class="token punctuation">:</span> <span class="token operator">?</span>Function<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 新建一个update  createUpdate() 下面是它的返回值  可以理解为一个更新单元</span>
  <span class="token comment">//   expirationTime: expirationTime,</span>
  <span class="token comment">//   tag: UpdateState,</span>
  <span class="token comment">//   payload: null,</span>
  <span class="token comment">//   callback: null,</span>
  <span class="token comment">//   next: null,</span>
  <span class="token comment">//   nextEffect: null,</span>
  <span class="token keyword">const</span> update <span class="token operator">=</span> <span class="token function">createUpdate</span><span class="token punctuation">(</span>expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// Caution: React DevTools currently depends on this property</span>
  <span class="token comment">// being called &quot;element&quot;.</span>
  update<span class="token punctuation">.</span>payload <span class="token operator">=</span> <span class="token punctuation">{</span>element<span class="token punctuation">}</span><span class="token punctuation">;</span>

  callback <span class="token operator">=</span> callback <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token punctuation">:</span> callback<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>callback <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">warningWithoutStack</span><span class="token punctuation">(</span>
      <span class="token keyword">typeof</span> callback <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">,</span>
      <span class="token string">'render(...): Expected the last optional `callback` argument to be a '</span> <span class="token operator">+</span>
        <span class="token string">'function. Instead received: %s.'</span><span class="token punctuation">,</span>
      callback<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    update<span class="token punctuation">.</span>callback <span class="token operator">=</span> callback<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 调用schedule的回调</span>
  <span class="token function">flushPassiveEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 延迟创建update quenes, 并把update 更新到update quenes中</span>
  <span class="token comment">// update 添加到 current.updateQuene.firstUpdate|lastUpdate</span>
  <span class="token function">enqueueUpdate</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> update<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">scheduleWork</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> expirationTime<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><h2 id="schedulework"><a href="#schedulework" class="header-anchor">#</a> scheduleWork</h2> <p><strong>scheduleWork</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">scheduleWork</span>
<span class="token punctuation">(</span><span class="token parameter">fiber<span class="token punctuation">:</span> Fiber<span class="token punctuation">,</span> expirationTime<span class="token punctuation">:</span> ExpirationTime</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 设置expirationTime &amp; 返回root节点的Fiber对象</span>
  <span class="token keyword">const</span> root <span class="token operator">=</span> <span class="token function">scheduleWorkToRoot</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// isWorking 在render和commit两个阶段都会为true</span>
  <span class="token comment">// 新的render过期时间不是noWork</span>
  <span class="token comment">// 之前的过期时间大于现在新的过期时间</span>
  <span class="token comment">// 表达的含义：当前没有任务在执行，之前执行过任务，同时当前的任务比之前执行的任务过期时间要小</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    <span class="token operator">!</span>isWorking <span class="token operator">&amp;&amp;</span>
    <span class="token comment">// nextRenderExpirationTime 在初始的时候是noWork， 被设置后不再是noWork</span>
    nextRenderExpirationTime <span class="token operator">!==</span> NoWork <span class="token operator">&amp;&amp;</span>
    <span class="token comment">// ExpirationTime时间越小， 优先级更高</span>
    expirationTime <span class="token operator">&gt;</span> nextRenderExpirationTime
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// This is an interruption. (Used for performance tracking.)</span>
    <span class="token comment">// 中断了执行 ， 因为有优先级更高的任务进来了 </span>
    <span class="token comment">// isWorking=false意味着，在上一个时间片执行完之后进这个判断，</span>
    <span class="token comment">// 有更高优先级的任务，则中断了之前任务的执行</span>
    interruptedBy <span class="token operator">=</span> fiber<span class="token punctuation">;</span>
    <span class="token comment">// 清空之前任务的的stack</span>
    <span class="token function">resetStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 更新最近和最早的时间</span>
  <span class="token function">markPendingPriorityLevel</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 要么没有任何任务 要么有任务但处于commitRoot阶段</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    <span class="token comment">// If we're in the render phase, we don't need to schedule this root</span>
    <span class="token comment">// for an update, because we'll do it before we exit...</span>
    <span class="token operator">!</span>isWorking <span class="token operator">||</span>
    isCommitting <span class="token operator">||</span>
    <span class="token comment">// ...unless this is a different root than the one we're rendering.</span>
    nextRoot <span class="token operator">!==</span> root
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> rootExpirationTime <span class="token operator">=</span> root<span class="token punctuation">.</span>expirationTime<span class="token punctuation">;</span>
    <span class="token function">requestWork</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> rootExpirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>nestedUpdateCount <span class="token operator">&gt;</span> <span class="token constant">NESTED_UPDATE_LIMIT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Reset this back to zero so subsequent updates don't throw.</span>
    nestedUpdateCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">invariant</span><span class="token punctuation">(</span>
      <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token string">'Maximum update depth exceeded. This can happen when a '</span> <span class="token operator">+</span>
        <span class="token string">'component repeatedly calls setState inside '</span> <span class="token operator">+</span>
        <span class="token string">'componentWillUpdate or componentDidUpdate. React limits '</span> <span class="token operator">+</span>
        <span class="token string">'the number of nested updates to prevent infinite loops.'</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div><h3 id="requestwork"><a href="#requestwork" class="header-anchor">#</a> requestWork</h3> <p><strong>requestWork</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">requestWork</span><span class="token punctuation">(</span><span class="token parameter">root<span class="token punctuation">:</span> FiberRoot<span class="token punctuation">,</span> expirationTime<span class="token punctuation">:</span> ExpirationTime</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 把root添加到调度队列， 链表的形式</span>
  <span class="token function">addRootToSchedule</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 在render过程当中， 直接返回return</span>
  <span class="token comment">// batchedUpdate 批处理  setState  isRendering=true   第二个setState</span>
  <span class="token comment">// 不会出现频繁式的更新</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isRendering<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Prevent reentrancy. Remaining work will be scheduled at the end of</span>
    <span class="token comment">// the currently rendering batch.</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>isBatchingUpdates<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
    <span class="token comment">// Flush work at the end of the batch.</span>
    <span class="token comment">// 执行unbatchedUpdates()时会设置为true</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isUnbatchingUpdates<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...unless we're inside unbatchedUpdates, in which case we should</span>
      <span class="token comment">// flush it now.</span>
      nextFlushedRoot <span class="token operator">=</span> root<span class="token punctuation">;</span>
      nextFlushedExpirationTime <span class="token operator">=</span> Sync<span class="token punctuation">;</span>
      <span class="token comment">// 立即执行更新</span>
      <span class="token function">performWorkOnRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> Sync<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 批处理 return 不执行</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// TODO: Get rid of Sync and use current time?</span>
  <span class="token comment">// 同步任务，直接执行</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>expirationTime <span class="token operator">===</span> Sync<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 立即同步执行</span>
    <span class="token function">performSyncWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 通过ExpirationTime 进行调度</span>
    <span class="token function">scheduleCallbackWithExpirationTime</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><p>requestWork 是 scheduleWork 中的一个重点
其中主要分成了三个分支：</p> <ul><li>isRendering</li> <li>isBatchingUpdates</li> <li>expirationTime === Sync</li></ul> <p>我们来分别解释一下</p> <p><strong>1. isRendering</strong></p> <p>isRendering 顾名思义在render过程当中， 此时直接返回return。</p> <p>batchedUpdate 批处理的时候，将 isRendering 置成 true，这样每次在执行 setState 时，都会走 isRendering 的分支直接返回，阻止更新，相当于暂停住，当第二个setState时依旧直接返回，避免出现频繁式的更新，也就是批处理。</p> <p><strong>2. isBatchingUpdates</strong></p> <p>isBatchingUpdates 中又有一个 isUnbatchingUpdates 分支。
isUnbatchingUpdates 会在执行 unbatchedUpdates() 时设置为true。
也就是在首次渲染的时候不需要进行批处理，所以就会进行立即更新</p> <p><strong>3. expirationTime === Sync</strong></p> <p>当前面的 expirationTime 被设置成了同步任务的时候，就会立即执行。
剩余的则会进入 scheduleCallbackWithExpirationTime 通过ExpirationTime 进行调度。</p> <h3 id="performworkonroot"><a href="#performworkonroot" class="header-anchor">#</a> performWorkOnRoot</h3> <p>再继续从 requestWork 深入，执行了 performWorkOnRoot 方法</p> <p><strong>1. 首先进入先将 isRendering 置成true，告诉外面，现在要开始干活了，不要来打扰我</strong></p> <p><strong>2. 判断是否是同步任务 if(!isYieldy)</strong></p> <p>进入分支后，判断是否存在任务了，如果 finishedWork 存在，就进行 commit，也就是 completeRoot()
如果没有任务，这个Root，之前有暂停的话，清除掉这个定时器，会尝试继续渲染。
之后会继续进行判断。</p> <p>总结起来两句话：</p> <p><strong>通过是否存在 finishedWork 来判断是执行 commit 还是继续render</strong></p> <p><strong>如果没有 finishedWork，执行 RenderRoot 后再判断是否执行 commit</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>    <span class="token comment">// update队列</span>
    <span class="token keyword">let</span> finishedWork <span class="token operator">=</span> root<span class="token punctuation">.</span>finishedWork<span class="token punctuation">;</span>
    <span class="token comment">// 判断是否存在任务了</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>finishedWork <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// This root is already complete. We can commit it.</span>
      <span class="token comment">// 存在任务了</span>
      <span class="token comment">// finishedWork存在，进行commit了</span>
      <span class="token function">completeRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> finishedWork<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// root.finishedWork 有可能是其他什么值 undefined 之类的，重新置成 null 没毛病</span>
      root<span class="token punctuation">.</span>finishedWork <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token comment">// If this root previously suspended, clear its existing timeout, since</span>
      <span class="token comment">// we're about to try rendering again.</span>
      <span class="token comment">// 如果这个Root，之前有暂停，清除掉这个定时器，会尝试继续渲染</span>
      <span class="token keyword">const</span> timeoutHandle <span class="token operator">=</span> root<span class="token punctuation">.</span>timeoutHandle<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>timeoutHandle <span class="token operator">!==</span> noTimeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        root<span class="token punctuation">.</span>timeoutHandle <span class="token operator">=</span> noTimeout<span class="token punctuation">;</span>
        <span class="token comment">// $FlowFixMe Complains noTimeout is not a TimeoutID, despite the check above</span>
        <span class="token function">cancelTimeout</span><span class="token punctuation">(</span>timeoutHandle<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 继续调度</span>
      <span class="token function">renderRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> isYieldy<span class="token punctuation">)</span><span class="token punctuation">;</span>
      finishedWork <span class="token operator">=</span> root<span class="token punctuation">.</span>finishedWork<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>finishedWork <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// We've completed the root. Commit it.</span>
        <span class="token comment">// 判断是否可以执行commit</span>
        <span class="token function">completeRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> finishedWork<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p><strong>3. 否则就是异步任务</strong></p> <p>跟同步的逻辑差不多</p> <p><strong>4. 最后任务结束再将 isRendering 置成false</strong></p> <h4 id="renderroot"><a href="#renderroot" class="header-anchor">#</a> renderRoot</h4> <p>再来看一下 performWorkOnRoot 中继续调度时调用的 renderRoot()</p> <p>其中下面这段代码是在hooks的时候用的</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 设置 ReactCurrentDispatcher， 包含所有hooks的实现</span>
  <span class="token keyword">const</span> previousDispatcher <span class="token operator">=</span> ReactCurrentDispatcher<span class="token punctuation">.</span>current<span class="token punctuation">;</span>
  ReactCurrentDispatcher<span class="token punctuation">.</span>current <span class="token operator">=</span> ContextOnlyDispatcher<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>再往下，判断是否有新的更新进来</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>
    expirationTime <span class="token operator">!==</span> nextRenderExpirationTime <span class="token operator">||</span>
    root <span class="token operator">!==</span> nextRoot <span class="token operator">||</span>
    nextUnitOfWork <span class="token operator">===</span> <span class="token keyword">null</span>
  <span class="token punctuation">)</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>进入 if 后</p> <p>创建一个镜像Fiber，赋值给alternate属性。
WorkInProgress 是当前fiber对象的一个镜像，当再次进入时，Fiber发生了变化，直接与 WorkInProgress Fiber 对比。相当于缓存了之前更新的结果，并且放在了 Fiber.alternate 上面。同时将 Fiber 挂在 WorkInProgress Fiber上，进行了一个双缓存</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>    <span class="token comment">// 重置</span>
    <span class="token function">resetStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    nextRoot <span class="token operator">=</span> root<span class="token punctuation">;</span>
    nextRenderExpirationTime <span class="token operator">=</span> expirationTime<span class="token punctuation">;</span>
    <span class="token comment">// 创建镜像Fiber， 赋值给alternate属性</span>
    <span class="token comment">// 是当前fiber对象的一个镜像，WorkInProgress Fiber对象</span>
    <span class="token comment">// Fiber发生了变化，直接与 WorkInProgress Fiber 对比</span>
    <span class="token comment">// Fiber.alternate = WorkInProgress Fiber</span>
    <span class="token comment">// WorkInProgress.alternate = Fiber</span>
    nextUnitOfWork <span class="token operator">=</span> <span class="token function">createWorkInProgress</span><span class="token punctuation">(</span>
      nextRoot<span class="token punctuation">.</span>current<span class="token punctuation">,</span>
      <span class="token keyword">null</span><span class="token punctuation">,</span>
      nextRenderExpirationTime<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>中间的逻辑忽略，继续向下找。 从这里开始了 workLoop，下面是一个do while(true)的大循环。
接下来就要进入到 workLoop 中去了。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>  <span class="token function">startWorkLoopTimer</span><span class="token punctuation">(</span>nextUnitOfWork<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">do</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token function">workLoop</span><span class="token punctuation">(</span>isYieldy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>thrownValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//......</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h4 id="workloop"><a href="#workloop" class="header-anchor">#</a> workLoop</h4> <p>workLoop 中调用 performUnitOfWork，performUnitOfWork 中又调用了 beginWork
workLoop =&gt; performUnitOfWork =&gt; beginWork
那我们直接来看 beginWork 的逻辑</p> <p>首先判断节点是否存在，然后进行新旧props判断。</p> <p>接下来用switch case 来判断不同的 workInProgress.tag 来进行入栈操作
<strong>beginWork</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> updateExpirationTime <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>expirationTime<span class="token punctuation">;</span>
  <span class="token comment">// 判断节点是否存在</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> oldProps <span class="token operator">=</span> current<span class="token punctuation">.</span>memoizedProps<span class="token punctuation">;</span>
    <span class="token keyword">const</span> newProps <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>pendingProps<span class="token punctuation">;</span>
    <span class="token comment">// 前后props是否相等</span>
    <span class="token comment">// 判断了是否有老版本context使用并且发生变化</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldProps <span class="token operator">!==</span> newProps <span class="token operator">||</span> <span class="token function">hasLegacyContextChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// If props or context changed, mark the fiber as having performed work.</span>
      <span class="token comment">// This may be unset if the props are determined to be equal later (memo).</span>
      didReceiveUpdate <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token comment">// 需要更新的优先级小于当前更新的优先级</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>updateExpirationTime <span class="token operator">&lt;</span> renderExpirationTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      didReceiveUpdate <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token comment">// switch (workInProgress.tag) case</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token function">bailoutOnAlreadyFinishedWork</span><span class="token punctuation">(</span>
        current<span class="token punctuation">,</span>
        workInProgress<span class="token punctuation">,</span>
        renderExpirationTime<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    didReceiveUpdate <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>再接下来</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code> <span class="token comment">// 在进入开始阶段之前，清除到期时间。</span>
  workInProgress<span class="token punctuation">.</span>expirationTime <span class="token operator">=</span> NoWork<span class="token punctuation">;</span>
  <span class="token comment">// 就根据不同的节点类型进行更新</span>
  <span class="token comment">// 真正在这个下面的逻辑里面打上标签EffectTag, 将 update 加入到 updateQuene 中，产生 finishWork</span>
  <span class="token comment">// update =&gt; updateQuene =&gt; finishWork</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token comment">// FunctionalComponent在第一次创建 Fiber 的时候就是 IndeterminateComponent</span>
    <span class="token comment">// 会调到 reconcileChildren 这个方法， 判断是否能够复用，执行节点的更新</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p><img src="react-render-core1.png" alt="react-render 流程"></p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/zxy/blog/edit/master/docs/blog/react源码2.md" target="_blank" rel="noopener noreferrer">本文源码地址</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">更新时间:</span> <span class="time">11/6/2019, 8:15:06 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/blog/react源码1.html" class="prev">React 源码解读（一）</a></span> <!----></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/blog/assets/js/app.14c06185.js" defer></script><script src="/blog/assets/js/2.16662708.js" defer></script><script src="/blog/assets/js/48.ec4dcb12.js" defer></script>
  </body>
</html>
